\section{Implementering af database og data-access layer}

\todo{Del evt kode op i mindre dele og forklar alt med henblik p√• User story vedr. pooldata}

\begin{lstlisting}[caption= GetChlorineData method, label=code:getChlorineData]

public List<Tuple<SensorTypes, double>> GetChlorineValues(string poolOwnerEmail, string poolName, int daysToGoBack)
{
double days = System.Convert.ToDouble(daysToGoBack);
string now = DateTime.UtcNow.ToString("G");
string start = DateTime.Parse(now).AddDays(-days).ToString("G");

using (var db = new DatabaseContext())
{   
DateTime startTime = DateTime.ParseExact(start, "dd/MM/yyyy HH:mm:ss", System.Globalization.CultureInfo.InvariantCulture);
DateTime endTime = DateTime.ParseExact(now, "dd/MM/yyyy HH:mm:ss", System.Globalization.CultureInfo.InvariantCulture);

var chlorineDataQuery = from chlorine in db.ChlorineSet
where chlorine.Data.Pool.Name == poolName && chlorine.Data.Pool.User.Email == poolOwnerEmail
select chlorine;

List<Tuple<SensorTypes, double>> chlorineTuples = new List<Tuple<SensorTypes, double>>();

foreach (var chlorine in chlorineDataQuery)
{
if(DateTime.Parse(chlorine.Data.Timestamp).CompareTo(endTime) < 0 ||
DateTime.Parse(chlorine.Data.Timestamp).CompareTo(startTime) > 0)
{
chlorineTuples.Add(new Tuple<SensorTypes, double>(SensorTypes.Chlorine, chlorine.Value));
}
}

return chlorineTuples;
}
}
\end{lstlisting}